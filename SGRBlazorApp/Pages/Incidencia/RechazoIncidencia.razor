@page "/rechazoIncidencia/{Id:guid}"
@using SGRBlazorApp.Data
@using SGRBlazorApp.Interfaces
@using CuriousDriveRazorLibrary
@using Blazored.LocalStorage
@using SGRBlazorApp.Shared
@using System.Security.Claims
@inject ISgrService<Incidencia> bookStoresService
@inject ISgrService<IncidenciaApi> incidenciaApiService
@inject ISgrService<Setting> settingService
@inject ISgrService<Dealer> dealerService
@inject ISgrService<Estado> estadoService
@inject ISgrService<EstadoIncidencium> estadoIncidenciaService
@inject IUserService userService
@inject ILocalStorageService localStorageService
@inject IJSRuntime JSRuntime
@inject NavigationManager navigationManager
@inject IEmailSenderService emailService
@implements IDisposable
@using System.Reactive.Linq;
@using System.Reactive.Subjects
@using SGRBlazorApp.Services
@inject GeocodingService GeocodingService

@if (isLoading)
{

    <div class="col-12 row">
        <div class="col-md-12">
            <h3><b>Informacion del Reclamo Nro @Incidencia.NumeroIncidencia</b></h3>
            <hr />
        </div>


        <div class="col-md-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Fecha Carga:</label>
            <input class="form-control col-12" value="@IncidenciaApi.fechaIncidencia" readonly />
        </div>
        <br />
        <div class="col-md-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Estado Actual:</label>
            <input class="form-control col-12" value="@IncidenciaApi.nombreEstadoIncidencia" readonly />
        </div>
        <br />
        <div class="col-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Equipo:</label>
            <input class="form-control col-12" value="@IncidenciaApi.Equipo" readonly />
        </div>

        <div class="col-md-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Nombre Contacto:</label>
            <input class="form-control col-12" value="@IncidenciaApi.nombreContacto" readonly />
        </div>
        <br />
        <div class="col-md-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Telefono:</label>
            <input class="form-control col-12" value="@IncidenciaApi.telefonoFijoContacto" readonly />
        </div>
        <br />
        <div class="col-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Email Contacto:</label>
            <input class="form-control col-12" value="@IncidenciaApi.emailContacto" readonly />
        </div>
        <br />
        <div class="col-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Hs o Km del Motor: </label>
            <div class="input-group mb-3">
                <input class="form-control col-12" value="@IncidenciaApi.horasTractor" readonly />
                <div class="input-group-append">
                    <span class="input-group-text" id="basic-addon2">@(IncidenciaApi.Aux3 == "1" ? "KM" : "HS")</span>
                </div>
            </div>
        </div>
        <br />
        <div class="col-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Fecha de compra: </label>
            <input class="form-control col-12" value="@IncidenciaApi.fechaCompra" readonly />
        </div>
        <br />
        <div class="col-md-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Numero Motor (ESN):</label>
            <input class="form-control col-12" value="@IncidenciaApi.numeroMotor" readonly />
        </div>
        <br />
        <div class="col-md-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Modelo Motor:</label>
            <input class="form-control col-12" value="@IncidenciaApi.ModeloMotor" readonly />
        </div>
        <br />
        <div class="col-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Modelo Equipo: </label>
            <input class="form-control col-12" value="@IncidenciaApi.ModeloEquipo" readonly />
        </div>
        <br />
        <div class="col-6" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Direccion Contacto: </label>
            <input class="form-control col-12" value="@IncidenciaApi.domicilioContacto" readonly />
        </div>
        <br />
        <div class="col-12" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Direccion de Inspeccion: </label>
            <input class="form-control col-12" value="@IncidenciaApi.DireccionInspeccion" readonly />
        </div><br />
        <div class="col-md-12" style="margin-top:15px">
            <label class="col-12 font-weight-bold">Sintoma:</label>
            <input class="form-control col-12" value="@IncidenciaApi.Sintoma" readonly />
        </div>
        <br />
        <div class="col-12 row" style="margin-top:15px;margin-bottom:20px">
            <h3><b>Ud ha decidido rechazar el Reclamo, a continuacion por favor explique los motivos del Rechazo. Muchas gracias!</b></h3>

        </div>
        <br />
        <div class="col-12 row">
            <span class="col-2"></span>
            <textarea class="form-control" cols="10" rows="10" @bind="@Observaciones" required></textarea>
        </div>
        <div class="col-12 row" style="margin-top:15px;margin-bottom:20px">
            <span class="col-2"></span>
            <a class="col-4 btn btn-primary" style="color:white" @onclick="(() => RechazarIncidencia(Incidencia.Id))">Rechazar </a>
            <span>&nbsp;</span>
            <a class="col-2 btn btn-success" href="/Incidencias">Cancelar</a>
        </div>
    </div>
}
else
{
    <div class="col-12" style="background-color: lightgray; height:400px; vertical-align:middle">
        <br /><br />
        <Chase Center="true" Color="#c21f13" Size="70px"></Chase>
    </div>
}


@code
{
    [Parameter]
    public Guid Id { get; set; }
    public Incidencia Incidencia { get; set; }
    public IncidenciaApi IncidenciaApi { get; set; }
    public List<IncidenciaApi> IncidenciaList { get; set; }
    public List<EstadoIncidencium> estadoIncidencia { get; set; }
    public List<Estado> estadosList { get; set; }
    public string Observaciones { get; set; }
    public Guid IdDealer { get; set; }
    public List<Dealer> Dealers { get; set; }
    public Dealer dealer { get; set; }
    bool isLoading = false;
    public Dictionary<Guid, double> distances = new Dictionary<Guid, double>();

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }
    ClaimsPrincipal user;
    bool IsUserAuthenticated;
    bool IsDealer;

    public SGRBlazorApp.Data.User user1 { get; set; }
    public RefreshRequest refreshRequest { get; set; }

    public void Dispose()
    {
        Console.WriteLine("Motors - Dispose");
    }

    protected override void OnInitialized()
    {
        Console.WriteLine("Clientes - OnInitialized");
        base.OnInitialized();
    }

    private void OnChangeEvent2(ChangeEventArgs changeEventArgs)
    {
        if (!String.IsNullOrEmpty((string)changeEventArgs.Value) && (string)changeEventArgs.Value != "Seleccione Dealer...")
        {
            IdDealer = Guid.Parse((string)changeEventArgs.Value);
            Incidencia.IdDealer = IdDealer;
        }
        //else
        //{
        //      Incidencia.IdDealer = null;
        //}
    }

    private async Task RechazarIncidencia(Guid ClienteId)
    {
        var confirmado = await JSRuntime.Confirmar("Atencion!", "¿Desea confirmar que Rechaza el Reclamo?", TipoMensajeSweetAlert.warning);
        if (String.IsNullOrEmpty(Observaciones))
        {
            await JSRuntime.MostrarMensaje("Atencion!", "Ingrese observaciones, es un campo obligatorio", TipoMensajeSweetAlert.error);
        }
        else if (confirmado)
        {
            try
            {
                EstadoIncidencium estado = new EstadoIncidencium();
                estado.IncidenciaId = ClienteId;
                estado.EstadoId = estadosList.FirstOrDefault(o => o.Descripcion == "Rechazado").Id;
                estado.Created = DateTime.Now;
                estado.IdUser = user1.Id;
                estado.Observacion = Observaciones;
                await estadoIncidenciaService.SaveAsync("EstadoIncidencia/CreateEstadoIncidencia/", estado);
                var incsIds = await estadoIncidenciaService.GetAllAsync("EstadoIncidencia/GetEstadoIncidenciasById/" + ClienteId.ToString());
                Guid idRec = estadosList.FirstOrDefault(o => o.Descripcion == "Rechazado").Id;
                if (incsIds.Where(o => o.EstadoId == idRec).Count() == 1)
                {
                    distances = GetDistances(IncidenciaApi.latitudGps, IncidenciaApi.longitudGps);
                    distances = distances.Where(o => o.Key != Incidencia.IdDealer).ToDictionary(i => i.Key, i => i.Value);
                    if (distances.Count > 0)
                    {
                        Incidencia.IdDealer = distances.OrderBy(o => o.Value).FirstOrDefault().Key;
                        await bookStoresService.UpdateAsync("Incidencia/UpdateIncidencia/", Id, Incidencia);
                        EstadoIncidencium estado2 = new EstadoIncidencium();
                        estado2.IncidenciaId = ClienteId;
                        estado2.EstadoId = estadosList.FirstOrDefault(o => o.Descripcion == "Pendiente").Id;
                        estado2.Created = DateTime.Now;
                        estado2.IdUser = user1.Id;
                        estado2.Observacion = "ASIGNACION AUTOMATICA DE NUEVO DEALER";
                        await estadoIncidenciaService.SaveAsync("EstadoIncidencia/CreateEstadoIncidencia/", estado2);
                    }
                }
                try
                {
                    if (!String.IsNullOrEmpty(dealer.Email))
                    {
                        if (dealer.Email.Contains(';'))
                        {
                            var mails = dealer.Email.Split(';');
                            foreach (var item in mails)
                            {
                                if (!String.IsNullOrEmpty(item))
                                {
                                    MailRequest mail1 = new MailRequest();
                                    mail1.Email = item;
                                    mail1.Nombre = dealer.Name;
                                    mail1.NumeroInc = IncidenciaApi.numeroIncidencia.ToString();
                                    mail1.EstadoInc = "Rechazado";
                                    mail1.Subject = "FAST - TEST";
                                    emailService.SendEmailAsyncEstado(mail1);
                                }
                            }
                        }
                    }
                    var settings = await settingService.GetAllAsync("Settings/GetSettings");
                    settings = settings.Where(o => o.Key == "Mail Aviso Estado").ToList();
                    foreach (var item in settings)
                    {
                        MailRequest mail = new MailRequest();
                        mail.Email = item.Value;
                        mail.Nombre = "Administrador";
                        mail.NumeroInc = IncidenciaApi.numeroIncidencia.ToString();
                        mail.EstadoInc = "Rechazado";
                        mail.Subject = "FAST - TEST";
                        emailService.SendEmailAsyncEstado(mail);
                    }
                }
                catch (Exception)
                {

                }
                navigationManager.NavigateTo("/Incidencias");
            }
            catch (Exception ex)
            {
                await JSRuntime.MostrarMensaje("Error!", "Ocurrio un error actualizando, por favor intente nuevamente!", TipoMensajeSweetAlert.error);
                Logger.AddLine(String.Format("{0}-{1}-{2}", DateTime.Now.ToString(), ex.Message, ex.StackTrace));
            }
        }
        //throw new Exception("DeleteCliente");
    }

    bool IsPublisher;
    bool IsSeniorEmployee;

    public int Count { get; set; } = 400;

    private SGRBlazorApp.Data.User users;

    protected override async Task OnInitializedAsync()
    {
        user = (await authenticationStateTask).User;

        if (!user.Identity.IsAuthenticated)
        {
            navigationManager.NavigateTo("/");
        }
        Console.WriteLine("Clientes - OnInitializedAsync");
        Incidencia = new Incidencia();
        IncidenciaApi = new IncidenciaApi();
        Incidencia = await bookStoresService.GetByIdAsync("Incidencia/GetIncidencia/", Id);
        IncidenciaList = await incidenciaApiService.GetAllAsync("Incidencia/GetIncidenciaApi");
        IncidenciaApi = IncidenciaList.FirstOrDefault(o => o.Id == Id);
        Dealers = await dealerService.GetAllAsync("Dealer/GetDealer");
        dealer = Dealers.FirstOrDefault(o => o.Id == Incidencia.IdDealer.Value);
        estadosList = new List<Estado>();
        estadosList = await estadoService.GetAllAsync("Estados/GetEstados");

        user = (await authenticationStateTask).User;



        if (user.Identity.IsAuthenticated)
            IsUserAuthenticated = true;

        if (user.IsInRole("Dealer"))
            IsDealer = true;

        refreshRequest = new RefreshRequest();
        refreshRequest.AccessToken = await localStorageService.GetItemAsync<string>("accessToken");
        refreshRequest.RefreshToken = await localStorageService.GetItemAsync<string>("refreshToken");
        user1 = await userService.RefreshTokenAsync(refreshRequest);
        isLoading = true;
        await base.OnInitializedAsync();
    }

    public const double EarthRadius = 6371;
    public double GetDistance(double Latitude1, double Longitude1, double Latitude2, double Longitude2)
    {
        double distance = 0;
        double Lat = (Latitude2 - Latitude1) * (Math.PI / 180);
        double Lon = (Longitude2 - Longitude1) * (Math.PI / 180);
        double a = Math.Sin(Lat / 2) * Math.Sin(Lat / 2) + Math.Cos(Latitude1 * (Math.PI / 180)) * Math.Cos(Latitude2 * (Math.PI / 180)) * Math.Sin(Lon / 2) * Math.Sin(Lon / 2);
        double c = 2 * Math.Atan2(Math.Sqrt(a), Math.Sqrt(1 - a));
        distance = EarthRadius * c;
        return distance;
    }

    public Dictionary<Guid, double> GetDistances(double lat, double lon)
    {
        Dictionary<Guid, double> diss = new Dictionary<Guid, double>();
        foreach (var item in Dealers)
        {
            if (item.LongitudGps != null && item.LatitudGps != null)
            {
                double dis = GetDistance(lat, lon, item.LatitudGps.Value, item.LongitudGps.Value);
                diss.Add(item.Id, dis);
            }
        }
        return diss;
    }
}
